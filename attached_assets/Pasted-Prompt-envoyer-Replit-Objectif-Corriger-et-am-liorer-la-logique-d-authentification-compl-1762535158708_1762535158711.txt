Prompt Ã  envoyer Ã  Replit :

ğŸ”§ Objectif : Corriger et amÃ©liorer la logique dâ€™authentification complÃ¨te (backend + frontend)

Le projet utilise :

Frontend : altusfinancegroup.com (Vercel)

Backend : api.altusfinancegroup.com (Render, Express + PostgreSQL)

ğŸš¨ ProblÃ¨me actuel :

AprÃ¨s inscription et validation du mail, la redirection vers le tableau de bord fonctionne mal.

Parfois lâ€™utilisateur a accÃ¨s au dashboard dans un onglet, mais pas dans un autre (la session nâ€™est pas reconnue).

La double authentification (2FA) est demandÃ©e alors quâ€™elle ne devrait pas lâ€™Ãªtre pour les nouveaux utilisateurs.

Le navigateur ne partage pas correctement la session entre les onglets (cookies cross-domain).

ğŸ¯ But recherchÃ© :

ImplÃ©menter une logique dâ€™authentification propre et rÃ©aliste :

1. Inscription

Lâ€™utilisateur sâ€™inscrit via email + mot de passe.

Il reÃ§oit un mail de validation (emailVerified = false).

Une fois le lien validÃ© â†’ emailVerified = true.

Redirection automatique vers la page de connexion.

Connexion directe (sans 2FA) et accÃ¨s au tableau de bord.

2. Activation 2FA (dans paramÃ¨tres)

Dans lâ€™espace utilisateur, il y a une section "SÃ©curitÃ©" avec une option â€œActiver la double authentificationâ€.

Lorsque lâ€™utilisateur clique :

Le backend gÃ©nÃ¨re un secret via speakeasy + un QR code (API /api/2fa/setup).

Le frontend affiche le QR code (Google Authenticator compatible).

Lâ€™utilisateur scanne et saisit un code 6 chiffres pour vÃ©rifier.

Si le code est correct :
user.twoFactorEnabled = true et user.twoFactorSecret (cryptÃ©) enregistrÃ©s en DB.

3. Connexion avec 2FA activÃ©

Si twoFactorEnabled = false â†’ connexion directe.

Si twoFactorEnabled = true :

AprÃ¨s saisie email + mot de passe, le backend rÃ©pond :

{ "requires2FA": true }


Le frontend affiche un champ â€œCode 2FAâ€.

Le code est validÃ© via /api/2fa/verify.

Si correct â†’ session crÃ©Ã©e â†’ accÃ¨s tableau de bord.

4. DÃ©connexion

Suppression de session (cookie invalidÃ©).

Lors de la prochaine connexion, si twoFactorEnabled = true, le code sera Ã  nouveau exigÃ©.

ğŸ§© DÃ©tails techniques Ã  vÃ©rifier :

Cookies cross-domain : configurer sameSite: "none", secure: true, et domain: ".altusfinancegroup.com".

Le backend doit accepter les requÃªtes CORS depuis https://altusfinancegroup.com.

Utiliser express-session avec connect-pg-simple pour stocker les sessions dans PostgreSQL.

Si non dÃ©jÃ  prÃ©sent : installer speakeasy et qrcode pour la gÃ©nÃ©ration et la validation du 2FA.

ğŸ“¦ RÃ©sumÃ© des endpoints Ã  vÃ©rifier/crÃ©er :

POST /api/auth/register

GET /api/auth/verify-email

POST /api/auth/login

POST /api/2fa/setup â†’ gÃ©nÃ¨re secret + QR code

POST /api/2fa/verify â†’ vÃ©rifie code 2FA

POST /api/auth/logout

âœ… Objectif final :

ExpÃ©rience fluide :

âœ… Validation email â†’ redirection â†’ connexion directe â†’ dashboard

âœ… Si 2FA activÃ© â†’ code requis Ã  la connexion

âœ… Cookies/session reconnus entre onglets et sur les domaines .altusfinancegroup.com

Aucun problÃ¨me de double login, ni de dÃ©connexion entre pages.

Merci dâ€™appliquer la correction complÃ¨te et de tester la logique en environnement Render + Vercel.